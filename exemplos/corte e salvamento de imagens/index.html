<!DOCTYPE html>
<html>
    <head>
        <title>Enviar cortar e salvar imagem</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="../../css/sm-default.css" rel="stylesheet" type="text/css"/>
        <link href="../../javascript/AjaxRequest/AjaxRequest.css" rel="stylesheet" type="text/css"/>
        <link href="../../javascript/ImageCut/ImageCut.css" rel="stylesheet" type="text/css"/>
        <link href="../../javascript/ImgPrev/ImgPrev.css" rel="stylesheet" type="text/css"/>
        <link href="../../javascript/ModalShow/ModalShow.css" rel="stylesheet" type="text/css"/>
        <script src="../../javascript/AjaxRequest/AjaxRequest.js" type="text/javascript"></script>
        <script src="../../javascript/ImageCut/ImageCut.js" type="text/javascript"></script>
        <script src="../../javascript/ImgPrev/ImgPrev.js" type="text/javascript"></script>
        <script src="../../javascript/ModalShow/ModalShow.js" type="text/javascript"></script>
        <style>
            .modal-box {
                max-width: 550px;
                min-width: 250px;
                min-height: 250px;
                resize: both;
                overflow: hidden
            }
            #previa,
            .cut-base {
                margin: auto
            }
        </style>
    </head>
    <body>
        <input type="file" id="enviar" accept=".jpg, .jpeg, .png, .gif, .bmp" class="input-default font-medium"/>

        <div class="modal" id="modal">
            <div class="modal-box zoom-in">
                <div id="preview-progress"></div>
                <div class="modal-header"></div>

                <div class="modal-content">
                    <div id="carregar-post"></div>
                    <form id="salvar_imagem" onsubmit="return (false);">
                        <div id="carregar-dados"></div>

                        <div class="padding-all-min">
                            <img id="previa" alt="Pré visualização" style="display:none"/>
                        </div>

                        <input type="hidden" name="input_send" id="input" />

                        <div class="row-pad font-medium text-white">
                            <div class="col-half">
                                <button class="btn-info button-block" id="cortar">Cortar</button>
                            </div>
                            <div class="col-half">
                                <button class="btn-success button-block" id="salvar">Enviar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            var modal = new ModalShow('modal');
            var send = new ImgPrev('enviar', 'carregar-dados');
            var previa = document.getElementById('previa');
            var input = document.getElementById('input');
            var corte = null;
            document.getElementById('enviar').addEventListener('change', carregar, false);

            function carregar() {
                restart();
                var alvo = document.getElementsByClassName('image-prev')[0];
                modal.open('Ajustar Corte', true);
                alvo.id = 'imagem-alvo';
                carregar.prototype = new ImageCut('imagem-alvo');
                corte = carregar.prototype;
                document.getElementById('cortar').addEventListener('click', cortar, false);
                document.getElementById('salvar').addEventListener('click', salvar, false);
            }

            function cortar() {
                corte.setCut();
                previa.src = corte.getImage();
                previa.style.display = 'block';
            }

            function salvar() {
                corte.setCut();
                input.value = corte.getImage();
                if (input.value) {
                    salvar.prototype = new AjaxRequest();
                    salvar.prototype.form('salvar_imagem', 'carregar-post', 'post.php');
                }
                return (false);
            }

            function restart() {
                previa.src = null;
                previa.style.display = 'none';
                document.getElementById('carregar-post').innerHTML = null;
                document.getElementById('salvar_imagem').style.display = 'block';
            }

        </script>
    </body>
</html>
